<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Validaci√≥n de Im√°genes</title>

    <!-- Librer√≠as necesarias -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #5a62d8, #7442c8);
            margin: 0;
            padding: 0;
            color: #fff;
        }

        .container {
            width: 90%;
            max-width: 1000px;
            background: #ffffff;
            color: #333;
            margin: 40px auto;
            padding: 35px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
        }

        h1 {
            text-align: center;
            margin-bottom: 5px;
            color: #fff;
        }

        .header {
            background: linear-gradient(135deg, #6f79ff, #844bdb);
            padding: 30px;
            border-radius: 15px 15px 0 0;
        }

        .zone {
            border: 3px dashed #7d8cff;
            padding: 40px;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #6f79ff, #844bdb);
            border: none;
            padding: 15px 35px;
            font-size: 18px;
            border-radius: 50px;
            color: #fff;
            cursor: pointer;
            margin-top: 10px;
            transition: 0.2s;
        }

        .btn:hover {
            transform: scale(1.05);
        }
    </style>
</head>

<body>

    <div class="header">
        <h1>üì∏ Sistema de Validaci√≥n de Im√°genes</h1>
        <p style="text-align:center; font-size:15px;">Versi√≥n r√°pida - Clasifica y extrae datos autom√°ticamente</p>
    </div>

    <div class="container">
        <div class="zone" id="drop-zone">
            <p>Arrastra tu archivo ZIP aqu√≠ o haz clic para seleccionar</p>
            <input type="file" id="zipInput" accept=".zip" style="display:none;">
            <button class="btn" onclick="document.getElementById('zipInput').click()">üìÇ Seleccionar archivo ZIP</button>
        </div>

        <div style="text-align:center;">
            <button class="btn" onclick="procesarZIP()">üöÄ Procesar Im√°genes</button>
        </div>
    </div>


<script>
let archivoZIP = null;

document.getElementById("zipInput").addEventListener("change", function(e) {
    archivoZIP = e.target.files[0];
});


// ‚≠ê EXTRACTOR OCR COMPLETO
async function extraerDatosOCR(imageBlob) {
    const { data: { text } } = await Tesseract.recognize(imageBlob, 'spa', {
        logger: m => console.log(m)
    });

    console.log("Texto detectado:", text);

    const fechaRegex = /(\d{4}-\d{2}-\d{2}\s+\d{1,2}:\d{2}\s*(AM|PM))/i;
    const mieRegex = /(MIE\d+)/i;
    const micoRegex = /(MICO\w+)/i;

    let tienda = "";
    const lineas = text.split("\n").map(l => l.trim());

    for (let linea of lineas) {
        if (!linea.match(mieRegex) && !linea.match(micoRegex) && !linea.match(fechaRegex) && linea.length > 2) {
            tienda = linea;
        }
    }

    return {
        fecha: text.match(fechaRegex)?.[1] || "",
        mie: text.match(mieRegex)?.[1] || "",
        tienda: tienda,
        mico: text.match(micoRegex)?.[1] || ""
    };
}



// ‚≠ê PROCESAR ZIP
async function procesarZIP() {
    if (!archivoZIP) {
        alert("Selecciona un archivo ZIP primero.");
        return;
    }

    const zip = await JSZip.loadAsync(archivoZIP);
    const excelData = [];

    for (const nombreArchivo of Object.keys(zip.files)) {
        if (!nombreArchivo.toLowerCase().match(/\.(jpg|jpeg|png)$/)) continue;

        const fileData = await zip.files[nombreArchivo].async("blob");

        // Ejecutar OCR
        const datos = await extraerDatosOCR(fileData);

        // Clasificar autom√°ticamente (solo ejemplo)
        const estado = datos.mie ? "approved" : "rejected";

        excelData.push({
            imagen: nombreArchivo,
            estado: estado,
            fecha: datos.fecha,
            mie: datos.mie,
            tienda: datos.tienda,
            mico: datos.mico
        });
    }

    generarExcel(excelData);
}



// ‚≠ê GENERAR EXCEL FINAL
function generarExcel(data) {
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();

    XLSX.utils.book_append_sheet(wb, ws, "Resultados");

    XLSX.writeFile(wb, "resultado_validacion.xlsx");
}
</script>

</body>
</html>
