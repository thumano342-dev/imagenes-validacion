<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Validaci√≥n de Im√°genes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .upload-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .upload-box {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: white;
            transition: all 0.3s;
        }
        
        .upload-box:hover {
            border-color: #764ba2;
            background: #f8f9ff;
        }
        
        .upload-box input[type="file"] {
            display: none;
        }
        
        .upload-label {
            cursor: pointer;
            display: inline-block;
            padding: 15px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.1em;
            transition: transform 0.2s;
        }
        
        .upload-label:hover {
            transform: scale(1.05);
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            margin: 5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        .status.loading {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .filters {
            padding: 20px 30px;
            background: #f8f9fa;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            border-bottom: 2px solid #e9ecef;
        }
        
        .filter-btn {
            padding: 10px 25px;
            border: 2px solid #667eea;
            background: white;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-left: auto;
        }
        
        .stat-box {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
        }
        
        .stat-approved {
            background: #d4edda;
            color: #155724;
        }
        
        .stat-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .gallery {
            padding: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .image-card {
            border: 3px solid #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            background: white;
            transition: all 0.3s;
            position: relative;
        }
        
        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .image-card.approved {
            border-color: #28a745;
        }
        
        .image-card.rejected {
            border-color: #dc3545;
        }
        
        .image-wrapper {
            position: relative;
            width: 100%;
            height: 250px;
            overflow: hidden;
            background: #f8f9fa;
        }
        
        .image-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.85em;
            color: white;
        }
        
        .status-badge.approved {
            background: #28a745;
        }
        
        .status-badge.rejected {
            background: #dc3545;
        }
        
        .image-info {
            padding: 15px;
        }
        
        .image-name {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .extracted-data {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85em;
            margin-bottom: 10px;
        }
        
        .extracted-data div {
            margin: 3px 0;
        }
        
        .data-label {
            font-weight: bold;
            color: #667eea;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn-small {
            padding: 8px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            flex: 1;
            transition: all 0.2s;
        }
        
        .btn-approve {
            background: #28a745;
            color: white;
        }
        
        .btn-reject {
            background: #dc3545;
            color: white;
        }
        
        .btn-small:hover {
            transform: scale(1.05);
        }
        
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .processing-overlay.active {
            display: flex;
        }
        
        .processing-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f3f3f3;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∏ Sistema de Validaci√≥n de Im√°genes</h1>
            <p>Sube tu ZIP, clasifica im√°genes y descarga el Excel con toda la informaci√≥n</p>
        </div>
        
        <div class="upload-section">
            <div class="upload-box">
                <label for="zipInput" class="upload-label">
                    üìÅ Seleccionar archivo ZIP
                </label>
                <input type="file" id="zipInput" accept=".zip" />
                <p style="margin-top: 15px; color: #666;">Arrastra tu archivo ZIP aqu√≠ o haz clic para seleccionar</p>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="procesarZip()">üöÄ Procesar Im√°genes</button>
                <button class="btn btn-success" onclick="generarExcel()" style="display:none;" id="btnExcel">
                    üìä Descargar Excel
                </button>
            </div>
            
            <div id="status"></div>
        </div>
        
        <div class="filters" style="display:none;" id="filters">
            <button class="filter-btn active" onclick="filtrar('all')">Todas</button>
            <button class="filter-btn" onclick="filtrar('approved')">‚úÖ Aprobadas</button>
            <button class="filter-btn" onclick="filtrar('rejected')">‚ùå Rechazadas</button>
            
            <div class="stats">
                <div class="stat-box stat-approved">
                    ‚úÖ <span id="countApproved">0</span>
                </div>
                <div class="stat-box stat-rejected">
                    ‚ùå <span id="countRejected">0</span>
                </div>
            </div>
        </div>
        
        <div class="gallery" id="gallery"></div>
    </div>
    
    <div class="processing-overlay" id="overlay">
        <div class="processing-content">
            <div class="spinner"></div>
            <h2 id="overlayTitle">Procesando im√°genes...</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar">0%</div>
            </div>
            <p id="overlayText">Esto puede tomar varios minutos</p>
        </div>
    </div>

    <script>
        const GITHUB_USERNAME = "thumano342-dev";
        const REPO_NAME = "imagenes-validacion";
        const BRANCH = "main";
        let GITHUB_TOKEN = "";
        
        let imagenes = [];
        let filtroActual = 'all';

        async function procesarZip() {
            const file = document.getElementById("zipInput").files[0];
            if (!file) {
                alert("Selecciona un archivo ZIP primero.");
                return;
            }
            
            if (!GITHUB_TOKEN) {
                GITHUB_TOKEN = prompt("Introduce tu token de GitHub:");
                if (!GITHUB_TOKEN) return;
            }

            mostrarOverlay(true, "Extrayendo im√°genes del ZIP...");

            const zip = new JSZip();
            const contenidoZip = await zip.loadAsync(file);
            
            imagenes = [];
            const extensionesValidas = ["jpg", "jpeg", "png", "gif", "bmp", "webp"];
            
            const archivosImagen = Object.keys(contenidoZip.files).filter(nombre => {
                const archivo = contenidoZip.files[nombre];
                if (archivo.dir) return false;
                if (nombre.startsWith("._") || nombre.includes("__MACOSX")) return false;
                const ext = nombre.split(".").pop().toLowerCase();
                return extensionesValidas.includes(ext);
            });

            for (let i = 0; i < archivosImagen.length; i++) {
                const nombre = archivosImagen[i];
                const archivo = contenidoZip.files[nombre];
                
                actualizarProgreso((i / archivosImagen.length) * 100, 
                    `Procesando imagen ${i + 1} de ${archivosImagen.length}`);

                const arrayBuffer = await archivo.async("arraybuffer");
                const bytes = new Uint8Array(arrayBuffer);
                const base64 = btoa(String.fromCharCode(...bytes));
                
                const cleanName = nombre.replace(/.*\//, "").replace(/[^\w.-]/g, "_");
                const dataUrl = `data:image/jpeg;base64,${base64}`;
                
                // Clasificar imagen
                const clasificacion = await clasificarImagen(dataUrl);
                
                // Extraer datos OCR
                const datosExtraidos = await extraerDatos(dataUrl);

                imagenes.push({
                    nombre: cleanName,
                    base64: base64,
                    dataUrl: dataUrl,
                    clasificacion: clasificacion,
                    datos: datosExtraidos,
                    url: null
                });
            }

            mostrarOverlay(false);
            mostrarGaleria();
            document.getElementById('btnExcel').style.display = 'inline-block';
            document.getElementById('filters').style.display = 'flex';
            actualizarEstadisticas();
        }

        async function clasificarImagen(dataUrl) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // Calcular nitidez (varianza de Laplaciano)
                    let suma = 0;
                    let count = 0;
                    for (let i = 0; i < data.length; i += 4) {
                        const gray = data[i] * 0.299 + data[i+1] * 0.587 + data[i+2] * 0.114;
                        suma += gray;
                        count++;
                    }
                    const promedio = suma / count;
                    
                    let varianza = 0;
                    for (let i = 0; i < data.length; i += 4) {
                        const gray = data[i] * 0.299 + data[i+1] * 0.587 + data[i+2] * 0.114;
                        varianza += Math.pow(gray - promedio, 2);
                    }
                    varianza /= count;
                    
                    // Calcular contraste
                    let min = 255, max = 0;
                    for (let i = 0; i < data.length; i += 4) {
                        const gray = data[i] * 0.299 + data[i+1] * 0.587 + data[i+2] * 0.114;
                        if (gray < min) min = gray;
                        if (gray > max) max = gray;
                    }
                    const contraste = max - min;
                    
                    // Clasificaci√≥n: Si tiene buena nitidez y contraste -> Aprobada
                    const aprobada = varianza > 200 && contraste > 50;
                    
                    resolve(aprobada ? 'approved' : 'rejected');
                };
                img.src = dataUrl;
            });
        }

        async function extraerDatos(dataUrl) {
            try {
                const result = await Tesseract.recognize(dataUrl, 'spa', {
                    logger: m => console.log(m)
                });
                
                const texto = result.data.text;
                
                // Extraer fecha (formatos: DD-MM-YYYY, YYYY-MM-DD, etc)
                const fechaMatch = texto.match(/\d{4}-\d{2}-\d{2}|\d{2}-\d{2}-\d{4}|\d{2}\/\d{2}\/\d{4}/);
                const fecha = fechaMatch ? fechaMatch[0] : "No detectado";
                
                // Extraer d√≠a de la semana
                const diasMatch = texto.match(/LUN|MAR|MIE|JUE|VIE|SAB|DOM/i);
                const dia = diasMatch ? diasMatch[0].toUpperCase() : "No detectado";
                
                // Extraer CAV (texto seguido de n√∫meros)
                const cavMatch = texto.match(/CAV\s*[A-Z\s]+/i) || texto.match(/[A-Z]{2,}\s+[A-Z\s]+/);
                const tienda = cavMatch ? cavMatch[0].trim() : "No detectado";
                
                // Extraer MICO/c√≥digo num√©rico
                const codigoMatch = texto.match(/MICO[D]?\d+/i) || texto.match(/\d{6,}/);
                const codigo = codigoMatch ? codigoMatch[0] : "No detectado";
                
                return { fecha, dia, tienda, codigo };
            } catch (error) {
                console.error("Error en OCR:", error);
                return {
                    fecha: "Error OCR",
                    dia: "Error OCR",
                    tienda: "Error OCR",
                    codigo: "Error OCR"
                };
            }
        }

        function mostrarGaleria() {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';
            
            imagenes.forEach((img, index) => {
                if (filtroActual !== 'all' && img.clasificacion !== filtroActual) return;
                
                const card = document.createElement('div');
                card.className = `image-card ${img.clasificacion}`;
                card.innerHTML = `
                    <div class="image-wrapper">
                        <img src="${img.dataUrl}" alt="${img.nombre}">
                        <div class="status-badge ${img.clasificacion}">
                            ${img.clasificacion === 'approved' ? '‚úÖ Aprobada' : '‚ùå Rechazada'}
                        </div>
                    </div>
                    <div class="image-info">
                        <div class="image-name">${img.nombre}</div>
                        <div class="extracted-data">
                            <div><span class="data-label">üìÖ Fecha:</span> ${img.datos.fecha}</div>
                            <div><span class="data-label">üìÜ D√≠a:</span> ${img.datos.dia}</div>
                            <div><span class="data-label">üè™ Tienda:</span> ${img.datos.tienda}</div>
                            <div><span class="data-label">üî¢ C√≥digo:</span> ${img.datos.codigo}</div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn-small btn-approve" onclick="cambiarClasificacion(${index}, 'approved')">
                                ‚úÖ Aprobar
                            </button>
                            <button class="btn-small btn-reject" onclick="cambiarClasificacion(${index}, 'rejected')">
                                ‚ùå Rechazar
                            </button>
                        </div>
                    </div>
                `;
                gallery.appendChild(card);
            });
        }

        function cambiarClasificacion(index, nuevaClasificacion) {
            imagenes[index].clasificacion = nuevaClasificacion;
            mostrarGaleria();
            actualizarEstadisticas();
        }

        function filtrar(tipo) {
            filtroActual = tipo;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            mostrarGaleria();
        }

        function actualizarEstadisticas() {
            const aprobadas = imagenes.filter(img => img.clasificacion === 'approved').length;
            const rechazadas = imagenes.filter(img => img.clasificacion === 'rejected').length;
            document.getElementById('countApproved').textContent = aprobadas;
            document.getElementById('countRejected').textContent = rechazadas;
        }

        async function generarExcel() {
            if (imagenes.length === 0) {
                alert("No hay im√°genes procesadas.");
                return;
            }

            const datos = [["Archivo", "Estado", "Fecha", "D√≠a", "Tienda", "C√≥digo", "Link"]];

            imagenes.forEach(img => {
                datos.push([
                    img.nombre,
                    img.clasificacion === 'approved' ? 'APROBADA' : 'RECHAZADA',
                    img.datos.fecha,
                    img.datos.dia,
                    img.datos.tienda,
                    img.datos.codigo,
                    img.url || "Sin subir a GitHub"
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(datos);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Validaci√≥n");

            XLSX.writeFile(wb, "validacion_imagenes.xlsx");
        }

        function mostrarOverlay(mostrar, titulo = "", texto = "") {
            const overlay = document.getElementById('overlay');
            if (mostrar) {
                document.getElementById('overlayTitle').textContent = titulo;
                document.getElementById('overlayText').textContent = texto;
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }

        function actualizarProgreso(porcentaje, texto) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = porcentaje + '%';
            progressBar.textContent = Math.round(porcentaje) + '%';
            document.getElementById('overlayText').textContent = texto;
        }

        // Mejorar la carga de archivos con drag & drop
        const uploadBox = document.querySelector('.upload-box');
        uploadBox.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadBox.style.borderColor = '#764ba2';
            uploadBox.style.background = '#f8f9ff';
        });
        
        uploadBox.addEventListener('dragleave', () => {
            uploadBox.style.borderColor = '#667eea';
            uploadBox.style.background = 'white';
        });
        
        uploadBox.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox.style.borderColor = '#667eea';
            uploadBox.style.background = 'white';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('zipInput').files = files;
            }
        });
    </script>
</body>
</html>
