<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Validaci√≥n de Im√°genes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .upload-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .upload-box {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: white;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-box:hover {
            border-color: #764ba2;
            background: #f8f9ff;
        }
        
        .upload-box.dragover {
            border-color: #28a745;
            background: #e8f5e9;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
        }
        
        .upload-label {
            cursor: pointer;
            display: inline-block;
            padding: 15px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.1em;
            transition: transform 0.2s;
        }
        
        .upload-label:hover {
            transform: scale(1.05);
        }
        
        .file-name {
            margin-top: 15px;
            color: #666;
            font-size: 1em;
        }
        
        .file-name.selected {
            color: #28a745;
            font-weight: bold;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            margin: 5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        .status.loading {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .filters {
            padding: 20px 30px;
            background: #f8f9fa;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            border-bottom: 2px solid #e9ecef;
        }
        
        .filter-btn {
            padding: 10px 25px;
            border: 2px solid #667eea;
            background: white;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-left: auto;
        }
        
        .stat-box {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
        }
        
        .stat-approved {
            background: #d4edda;
            color: #155724;
        }
        
        .stat-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .gallery {
            padding: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }
        
        .image-card {
            border: 3px solid #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            background: white;
            transition: all 0.3s;
            position: relative;
        }
        
        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .image-card.approved {
            border-color: #28a745;
        }
        
        .image-card.rejected {
            border-color: #dc3545;
        }
        
        .image-wrapper {
            position: relative;
            width: 100%;
            height: 250px;
            overflow: hidden;
            background: #f8f9fa;
        }
        
        .image-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.85em;
            color: white;
        }
        
        .status-badge.approved {
            background: #28a745;
        }
        
        .status-badge.rejected {
            background: #dc3545;
        }
        
        .image-info {
            padding: 15px;
        }
        
        .image-name {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            word-break: break-word;
            font-size: 0.9em;
        }
        
        .data-inputs {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .data-inputs input {
            width: 100%;
            padding: 6px;
            margin: 3px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.85em;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn-small {
            padding: 8px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            flex: 1;
            transition: all 0.2s;
        }
        
        .btn-approve {
            background: #28a745;
            color: white;
        }
        
        .btn-reject {
            background: #dc3545;
            color: white;
        }
        
        .btn-small:hover {
            transform: scale(1.05);
        }
        
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .processing-overlay.active {
            display: flex;
        }
        
        .processing-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f3f3f3;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .bulk-actions {
            padding: 15px 30px;
            background: #fff3cd;
            border-bottom: 2px solid #ffc107;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .bulk-actions strong {
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∏ Sistema de Validaci√≥n de Im√°genes</h1>
            <p>Versi√≥n r√°pida - Clasifica y agrega datos manualmente</p>
        </div>
        
        <div class="upload-section">
            <div class="upload-box" id="uploadBox">
                <div class="file-input-wrapper">
                    <input type="file" id="zipInput" accept=".zip">
                    <label for="zipInput" class="upload-label">üìÅ Seleccionar archivo ZIP</label>
                </div>
                <p class="file-name" id="fileName">Arrastra tu archivo ZIP aqu√≠ o haz clic para seleccionar</p>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" id="btnProcesar" onclick="procesarZip()">üöÄ Procesar Im√°genes</button>
                <button class="btn btn-success" onclick="generarExcel()" style="display:none;" id="btnExcel">
                    üìä Descargar Excel
                </button>
            </div>
            
            <div id="status"></div>
        </div>
        
        <div class="bulk-actions" style="display:none;" id="bulkActions">
            <strong>Acciones masivas:</strong>
            <button class="btn btn-primary" onclick="aprobarTodas()" style="padding: 8px 20px; font-size: 0.9em;">
                ‚úÖ Aprobar Todas
            </button>
            <button class="btn" onclick="rechazarTodas()" style="padding: 8px 20px; font-size: 0.9em; background: #dc3545; color: white;">
                ‚ùå Rechazar Todas
            </button>
        </div>
        
        <div class="filters" style="display:none;" id="filters">
            <button class="filter-btn active" onclick="filtrar('all')">Todas</button>
            <button class="filter-btn" onclick="filtrar('approved')">‚úÖ Aprobadas</button>
            <button class="filter-btn" onclick="filtrar('rejected')">‚ùå Rechazadas</button>
            
            <div class="stats">
                <div class="stat-box stat-approved">
                    ‚úÖ <span id="countApproved">0</span>
                </div>
                <div class="stat-box stat-rejected">
                    ‚ùå <span id="countRejected">0</span>
                </div>
            </div>
        </div>
        
        <div class="gallery" id="gallery"></div>
    </div>
    
    <div class="processing-overlay" id="overlay">
        <div class="processing-content">
            <div class="spinner"></div>
            <h2 id="overlayTitle">Extrayendo im√°genes...</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar">0%</div>
            </div>
            <p id="overlayText">Procesando archivos del ZIP</p>
        </div>
    </div>

    <script>
        let imagenes = [];
        let filtroActual = 'all';
        
        const zipInput = document.getElementById('zipInput');
        const uploadBox = document.getElementById('uploadBox');
        const fileName = document.getElementById('fileName');
        
        // Evento cuando se selecciona archivo
        zipInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                fileName.textContent = `üì¶ Archivo seleccionado: ${file.name}`;
                fileName.classList.add('selected');
            }
        });
        
        // Drag and drop
        uploadBox.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadBox.classList.add('dragover');
        });
        
        uploadBox.addEventListener('dragleave', () => {
            uploadBox.classList.remove('dragover');
        });
        
        uploadBox.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.endsWith('.zip')) {
                zipInput.files = files;
                fileName.textContent = `üì¶ Archivo seleccionado: ${files[0].name}`;
                fileName.classList.add('selected');
            }
        });

        async function procesarZip() {
            const file = zipInput.files[0];
            if (!file) {
                alert("Por favor selecciona un archivo ZIP primero.");
                return;
            }

            mostrarOverlay(true, "Extrayendo im√°genes del ZIP...");

            try {
                const zip = new JSZip();
                const contenidoZip = await zip.loadAsync(file);
                
                imagenes = [];
                const extensionesValidas = ["jpg", "jpeg", "png", "gif", "bmp", "webp"];
                
                const archivosImagen = Object.keys(contenidoZip.files).filter(nombre => {
                    const archivo = contenidoZip.files[nombre];
                    if (archivo.dir) return false;
                    if (nombre.startsWith("._") || nombre.includes("__MACOSX")) return false;
                    const ext = nombre.split(".").pop().toLowerCase();
                    return extensionesValidas.includes(ext);
                });

                for (let i = 0; i < archivosImagen.length; i++) {
                    const nombre = archivosImagen[i];
                    const archivo = contenidoZip.files[nombre];
                    
                    actualizarProgreso((i / archivosImagen.length) * 100, 
                        `Procesando ${i + 1} de ${archivosImagen.length}`);

                    const arrayBuffer = await archivo.async("arraybuffer");
                    const bytes = new Uint8Array(arrayBuffer);
                    const base64 = btoa(String.fromCharCode(...bytes));
                    
                    const cleanName = nombre.replace(/.*\//, "");
                    const dataUrl = `data:image/jpeg;base64,${base64}`;
                    
                    // Clasificaci√≥n autom√°tica simple
                    const clasificacion = await clasificarImagenRapido(dataUrl);

                    imagenes.push({
                        nombre: cleanName,
                        base64: base64,
                        dataUrl: dataUrl,
                        clasificacion: clasificacion,
                        fecha: "",
                        dia: "",
                        tienda: "",
                        codigo: ""
                    });
                }

                mostrarOverlay(false);
                mostrarGaleria();
                document.getElementById('btnExcel').style.display = 'inline-block';
                document.getElementById('filters').style.display = 'flex';
                document.getElementById('bulkActions').style.display = 'flex';
                actualizarEstadisticas();
                
                document.getElementById('status').innerHTML = 
                    '<div class="status success">‚úÖ ¬°Listo! ' + imagenes.length + 
                    ' im√°genes procesadas. Revisa y clasifica cada una.</div>';
            } catch (error) {
                mostrarOverlay(false);
                alert("Error al procesar el ZIP: " + error.message);
            }
        }

        async function clasificarImagenRapido(dataUrl) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // Calcular brillo promedio
                    let suma = 0;
                    for (let i = 0; i < data.length; i += 4) {
                        suma += data[i] * 0.299 + data[i+1] * 0.587 + data[i+2] * 0.114;
                    }
                    const promedio = suma / (data.length / 4);
                    
                    // Calcular varianza
                    let varianza = 0;
                    for (let i = 0; i < data.length; i += 4) {
                        const gray = data[i] * 0.299 + data[i+1] * 0.587 + data[i+2] * 0.114;
                        varianza += Math.pow(gray - promedio, 2);
                    }
                    varianza /= (data.length / 4);
                    
                    // Si tiene buena varianza (no es uniforme) -> aprobada
                    const aprobada = varianza > 300;
                    
                    resolve(aprobada ? 'approved' : 'rejected');
                };
                img.src = dataUrl;
            });
        }

        function mostrarGaleria() {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';
            
            imagenes.forEach((img, index) => {
                if (filtroActual !== 'all' && img.clasificacion !== filtroActual) return;
                
                const card = document.createElement('div');
                card.className = `image-card ${img.clasificacion}`;
                card.innerHTML = `
                    <div class="image-wrapper">
                        <img src="${img.dataUrl}" alt="${img.nombre}">
                        <div class="status-badge ${img.clasificacion}">
                            ${img.clasificacion === 'approved' ? '‚úÖ Aprobada' : '‚ùå Rechazada'}
                        </div>
                    </div>
                    <div class="image-info">
                        <div class="image-name">${img.nombre}</div>
                        <div class="data-inputs">
                            <input type="text" placeholder="üìÖ Fecha (ej: 2025-12-03)" 
                                value="${img.fecha}" 
                                onchange="actualizarDato(${index}, 'fecha', this.value)">
                            <input type="text" placeholder="üìÜ D√≠a (ej: MIE)" 
                                value="${img.dia}" 
                                onchange="actualizarDato(${index}, 'dia', this.value)">
                            <input type="text" placeholder="üè™ Tienda (ej: CAV LA REBECA)" 
                                value="${img.tienda}" 
                                onchange="actualizarDato(${index}, 'tienda', this.value)">
                            <input type="text" placeholder="üî¢ C√≥digo (ej: MICO00059)" 
                                value="${img.codigo}" 
                                onchange="actualizarDato(${index}, 'codigo', this.value)">
                        </div>
                        <div class="action-buttons">
                            <button class="btn-small btn-approve" onclick="cambiarClasificacion(${index}, 'approved')">
                                ‚úÖ Aprobar
                            </button>
                            <button class="btn-small btn-reject" onclick="cambiarClasificacion(${index}, 'rejected')">
                                ‚ùå Rechazar
                            </button>
                        </div>
                    </div>
                `;
                gallery.appendChild(card);
            });
        }

        function actualizarDato(index, campo, valor) {
            imagenes[index][campo] = valor;
        }

        function cambiarClasificacion(index, nuevaClasificacion) {
            imagenes[index].clasificacion = nuevaClasificacion;
            mostrarGaleria();
            actualizarEstadisticas();
        }

        function aprobarTodas() {
            imagenes.forEach(img => img.clasificacion = 'approved');
            mostrarGaleria();
            actualizarEstadisticas();
        }

        function rechazarTodas() {
            imagenes.forEach(img => img.clasificacion = 'rejected');
            mostrarGaleria();
            actualizarEstadisticas();
        }

        function filtrar(tipo) {
            filtroActual = tipo;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            mostrarGaleria();
        }

        function actualizarEstadisticas() {
            const aprobadas = imagenes.filter(img => img.clasificacion === 'approved').length;
            const rechazadas = imagenes.filter(img => img.clasificacion === 'rejected').length;
            document.getElementById('countApproved').textContent = aprobadas;
            document.getElementById('countRejected').textContent = rechazadas;
        }

        function generarExcel() {
            if (imagenes.length === 0) {
                alert("No hay im√°genes procesadas.");
                return;
            }

            const datos = [["Archivo", "Estado", "Fecha", "D√≠a", "Tienda", "C√≥digo"]];

            imagenes.forEach(img => {
                datos.push([
                    img.nombre,
                    img.clasificacion === 'approved' ? 'APROBADA' : 'RECHAZADA',
                    img.fecha || "",
                    img.dia || "",
                    img.tienda || "",
                    img.codigo || ""
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(datos);
            
            // Ajustar ancho de columnas
            ws['!cols'] = [
                { wch: 30 }, // Archivo
                { wch: 12 }, // Estado
                { wch: 15 }, // Fecha
                { wch: 10 }, // D√≠a
                { wch: 25 }, // Tienda
                { wch: 15 }  // C√≥digo
            ];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Validaci√≥n");

            const fecha = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `validacion_imagenes_${fecha}.xlsx`);
        }

        function mostrarOverlay(mostrar, titulo = "", texto = "") {
            const overlay = document.getElementById('overlay');
            if (mostrar) {
                document.getElementById('overlayTitle').textContent = titulo;
                document.getElementById('overlayText').textContent = texto;
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }

        function actualizarProgreso(porcentaje, texto) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = porcentaje + '%';
            progressBar.textContent = Math.round(porcentaje) + '%';
            document.getElementById('overlayText').textContent = texto;
        }
    </script>
</body>
</html>

